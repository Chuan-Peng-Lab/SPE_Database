---
title: "Draw_pic_v2"
author: "czx"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
library(ggplot2)
library(dplyr)
library(purrr) 
library(car)  # 用于方差分析
library(emmeans)  # 用于事后检验
```

## 人口统计学数据读取
```{r Pic1}
#人口统计学数据读取
library(dplyr)

subject_counts <- lapply(names(df), function(paper_name) {
  data <- df[[paper_name]]
  
  if ("Subject" %in% names(data)) {
    if ("Gender" %in% names(data)) {
      # 如果有性别信息
      gender_summary <- data %>%
        distinct(Subject, Gender) %>%
        summarise(
          total_subjects = n_distinct(Subject, na.rm = TRUE),
          male_count = sum(Gender == "Male", na.rm = TRUE),
          female_count = sum(Gender == "Female", na.rm = TRUE),
          paper_name = paper_name,
          .groups = "drop"
        )
    } else {
      # 如果没有性别信息，统计总被试数
      gender_summary <- data %>%
        distinct(Subject) %>%
        summarise(
          total_subjects = n_distinct(Subject, na.rm = TRUE),
          male_count = NA,
          female_count = NA,
          paper_name = paper_name,
          .groups = "drop"
        )
    }
    return(gender_summary)
  } else {
    return(NULL)
  }
})

# 转换为数据框，去除NULL值
subject_counts_df <- do.call(rbind, subject_counts)

print(subject_counts_df)


# 输出为CSV文件
# write.csv(subject_counts_df, "Subject_information.csv", row.names = FALSE)

rm(subject_counts)
```


## 原始分类(画图用)
```{r}
# 将列表转换为数据框并添加Condition列
df_combined <- bind_rows(
  map_dfr(df_Self_Stranger, ~{
    df_temp <- as.data.frame(.x)  # 将列表转换为数据框
    mutate(df_temp, Condition = "Self-Stranger")  # 添加Condition列
  }),
  
  map_dfr(df_Self_Familiar, ~{
    df_temp <- as.data.frame(.x)  # 将列表转换为数据框
    mutate(df_temp, Condition = "Self-Familiar")  # 添加Condition列
  }),
  
  map_dfr(df_Self_Mother, ~{
    df_temp <- as.data.frame(.x)  # 将列表转换为数据框
    mutate(df_temp, Condition = "Self-Mother")  # 添加Condition列
  }),
  
  map_dfr(df_Self_Acquaintance, ~{
    df_temp <- as.data.frame(.x)  # 将列表转换为数据框
    mutate(df_temp, Condition = "Self-Acquaintance")  # 添加Condition列
  }),
  
  # map_dfr(df_Self_Others, ~{
  #   df_temp <- as.data.frame(.x)  # 将列表转换为数据框
  #   mutate(df_temp, Condition = "Self-Others")  # 添加Condition列
  # }),
  
  map_dfr(df_Self_Friend, ~{
    df_temp <- as.data.frame(.x)  # 将列表转换为数据框
    mutate(df_temp, Condition = "Self-Friend")  # 添加Condition列
  })
)

# 查看合并后的数据框
head(df_combined)
# 输出到新的CSV文件
write.csv(df_combined, "../1_Clean_Data/d_prime/df_combined.csv", row.names = FALSE)
```

## 探索1
```{r}
# 将列表转换为数据框并添加Condition列
df_combined <- bind_rows(
  map_dfr(df_Self_Stranger, ~{
    df_temp <- as.data.frame(.x)  # 将列表转换为数据框
    mutate(df_temp, Condition = "Self-Stranger")  # 添加Condition列
  }),
  
  map_dfr(df_Self_Familiar, ~{
    df_temp <- as.data.frame(.x)  # 将列表转换为数据框
    mutate(df_temp, Condition = "Self-Familiar")  # 添加Condition列
  }),
  
  map_dfr(df_Self_Mother, ~{
    df_temp <- as.data.frame(.x)  # 将列表转换为数据框
    mutate(df_temp, Condition = "Self-Familiar")  # 添加Condition列
  }),
  
  map_dfr(df_Self_Acquaintance, ~{
    df_temp <- as.data.frame(.x)  # 将列表转换为数据框
    mutate(df_temp, Condition = "Self-Familiar")  # 添加Condition列
  }),
  
  # map_dfr(df_Self_Others, ~{
  #   df_temp <- as.data.frame(.x)  # 将列表转换为数据框
  #   mutate(df_temp, Condition = "Self-Others")  # 添加Condition列
  # }),
  
  map_dfr(df_Self_Friend, ~{
    df_temp <- as.data.frame(.x)  # 将列表转换为数据框
    mutate(df_temp, Condition = "Self-Familiar")  # 添加Condition列
  })
)

# 查看合并后的数据框
head(df_combined)

```

```{r}
# 画 Cohen's d for RT
ggplot(df_combined, aes(x = Condition, y = Cohens_d_RT, color = Condition, fill = Condition)) +
  geom_violin(trim = FALSE, alpha = 0.6, position = position_dodge(width = 0.8)) +  # dodge to avoid overlap
  geom_jitter(size = 2, shape = 16, color = "black", position = position_dodge(width = 0.8)) +  # dodge for jitter as well
  theme_minimal() +
  labs(title = "Cohen's d for RT", y = "Cohen's d", x = "Condition") +
  theme(legend.position = "right") +  # 显示图例
  theme(plot.title = element_text(hjust = 0.5))

# 画 Cohen's d for ACC
ggplot(df_combined, aes(x = Condition, y = Cohens_d_ACC, color = Condition, fill = Condition)) +
  geom_violin(trim = FALSE, alpha = 0.6, position = position_dodge(width = 0.8)) +  # dodge to avoid overlap
  geom_jitter(size = 2, shape = 16, color = "black", position = position_dodge(width = 0.8)) +  # dodge for jitter as well
  theme_minimal() +
  labs(title = "Cohen's d for ACC", y = "Cohen's d", x = "Condition") +
  theme(legend.position = "right") +  # 显示图例
  theme(plot.title = element_text(hjust = 0.5))


```

```{r}
library(ggplot2)

# 画 Cohen's d for RT
ggplot(df_combined, aes(x = Condition, y = Cohens_d_RT, fill = Condition)) +
  geom_violin(trim = FALSE, alpha = 0.5) +  # 小提琴图，透明度设置为 0.5
  geom_boxplot(width = 0.1, outlier.shape = NA, color = "black") +  # 中间的箱线图，去除离群点
  geom_jitter(width = 0.2, size = 1.5, alpha = 0.5, color = "darkblue") +  # 散点图，轻微抖动，透明度 0.3
  theme_minimal() +
  labs(title = "Cohen's d for RT", y = "Cohen's d", x = "Condition") +
  theme(legend.position = "none") +  # 隐藏图例
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values = c("Self-Stranger" = "orange", "Self-Familiar" = "yellow"))  # 自定义颜色

# 画 Cohen's d for ACC
ggplot(df_combined, aes(x = Condition, y = Cohens_d_ACC, fill = Condition)) +
  geom_violin(trim = FALSE, alpha = 0.5) +  # 小提琴图，透明度设置为 0.5
  geom_boxplot(width = 0.1, outlier.shape = NA, color = "black") +  # 中间的箱线图，去除离群点
  geom_jitter(width = 0.2, size = 1.5, alpha = 0.3, color = "darkgreen") +  # 散点图，轻微抖动，透明度 0.3
  theme_minimal() +
  labs(title = "Cohen's d for ACC", y = "Cohen's d", x = "Condition") +
  theme(legend.position = "none") +  # 隐藏图例
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values = c("Self-Stranger" = "lightgreen", "Self-Familiar" = "lightyellow"))  # 自定义颜色

```

```{r}
# 画 Cohen's d for RT
ggplot(df_combined, aes(x = Condition, y = Cohens_d_RT, color = Condition)) +
  geom_violin(trim = FALSE,fill = "lightblue", alpha = 0.6) +  # 小提琴图，透明度设置为 0.5
  geom_violin(trim = FALSE, alpha = 0.5, draw_quantiles = c(0.5)) +  # 小提琴图显示一半
  geom_boxplot(width = 0.1, outlier.shape = NA, color = "black") +  # 中间的箱线图，去除离群点
  geom_jitter(width = 0.2, size = 1.5, alpha = 0.5, color = "darkblue") +  # 散点图，轻微抖动，透明度 0.3
  theme_minimal() +

  # geom_violin(trim = FALSE, fill = "lightblue", alpha = 0.6) +
  # geom_jitter(width = 0.1, size = 2, shape = 16, color = "darkblue") +
  # theme_minimal() +
  labs(title = "Cohen's d for RT", y = "Cohen's d", x = "Condition") +
  theme(legend.position = "none") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~Condition)  # 按Condition分面

```


```{r}
library(ggplot2)

# 画 Cohen's d for RT
ggplot(df_combined, aes(x = Condition, y = Cohens_d_RT, fill = Condition)) +
  geom_violin(trim = FALSE, alpha = 0.5, draw_quantiles = c(0.5)) +  # 小提琴图显示一半
  geom_boxplot(width = 0.1, outlier.shape = NA, color = "black") +  # 中间的箱线图
  geom_jitter(width = 0.2, size = 1.5, alpha = 0.3, color = "darkblue") +  # 散点图
  theme_minimal() +
  labs(title = "Cohen's d for RT", y = "Cohen's d", x = "Condition") +
  theme(legend.position = "none") +  # 隐藏图例
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values = c("Self-Stranger" = "orange", "Self-Familiar" = "yellow")) +
  coord_cartesian(clip = "off") +  # 防止绘图区域裁剪掉小提琴图的一部分
  theme(axis.text.x = element_text(hjust = 0.5))  # 调整x轴标签位置

# 画 Cohen's d for ACC
ggplot(df_combined, aes(x = Condition, y = Cohens_d_ACC, fill = Condition)) +
  geom_violin(trim = FALSE, alpha = 0.5, draw_quantiles = c(0.5)) +  # 小提琴图显示一半
  geom_boxplot(width = 0.1, outlier.shape = NA, color = "black") +  # 中间的箱线图
  geom_jitter(width = 0.2, size = 1.5, alpha = 0.3, color = "darkgreen") +  # 散点图
  theme_minimal() +
  labs(title = "Cohen's d for ACC", y = "Cohen's d", x = "Condition") +
  theme(legend.position = "none") +  # 隐藏图例
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(values = c("Self-Stranger" = "lightgreen", "Self-Familiar" = "lightyellow")) +
  coord_cartesian(clip = "off") +  # 防止绘图区域裁剪掉小提琴图的一部分
  theme(axis.text.x = element_text(hjust = 0.5))  # 调整x轴标签位置

```

## Data Extraction
```{r}
# 如果没有安装 dplyr，请先安装
# install.packages("dplyr")

# 提取并重命名
df_raw <- lapply(df, function(x) {
  x %>%
    select(Subject, Identity, Matching, RT_ms, ACC)  # 只选择需要的列
})

# 针对每篇文章计算每个被试的平均RT和ACC，同时保留原始列
df_raw_avg <- lapply(df_raw, function(x) {
  x %>%
    group_by(Subject, Identity, Matching) %>%
    summarise(
      RT_ms = mean(RT_ms, na.rm = TRUE),     # 保留原始数据中的RT_ms
      ACC = mean(ACC, na.rm = TRUE)           # 保留原始数据中的ACC
    )
})

# 查看每篇文章的平均结果（例如第一篇文章）
head(df_raw_avg[[1]])

# 合并所有文章的数据
df_raw_Total <- bind_rows(df_raw_avg, .id = "Paper")

# 查看合并后的数据框的前几行
head(df_raw_Total)
rm(df_raw,df_raw_avg)
```


# ANOVA 

```{r}
# 方差分析（ANOVA）
anova_result <- aov(RT_ms ~ Identity, data = df_raw_Total)

# 查看方差分析结果
summary(anova_result)

# Bonferroni 事后分析
posthoc_result <- pairwise.t.test(df_raw_Total$RT_ms, df_raw_Total$Identity, p.adjust.method = "bonferroni")

# 查看事后分析结果
posthoc_result

```


```{r}
# 加载必要的包


# 确保数据类型正确
df_combined <- df_combined %>%
  mutate(
    Condition = factor(Condition)  # 将Condition转为因子变量
    # Identity 列未在提供的数据中，如果有需要补充，请确认
  )

# 方差分析（ANOVA）：RT作为自变量
# 在没有明确的Identity列时，假设使用Condition作为因变量
anova_model <- aov(deta_RT ~ Condition, data = df_combined)

# 输出方差分析结果
summary(anova_model)

# 进行事后检验（Bonferroni校正）
posthoc_results <- emmeans(anova_model, pairwise ~ Condition, adjust = "bonferroni")

# 输出事后检验结果
summary(posthoc_results)
rm(anova_model,posthoc_results)
```







# Cohens d
```{r}
# 画 Cohen's d for RT
ggplot(df_combined, aes(x = Condition, y = Cohens_d_RT, color = Condition)) +
  geom_violin(trim = FALSE, fill = "lightblue", alpha = 0.6) +
  geom_jitter(width = 0.1, size = 2, shape = 16, color = "darkblue") +
  theme_minimal() +
  labs(title = "Cohen's d for RT", y = "Cohen's d", x = "Condition") +
  theme(legend.position = "none") +
  theme(plot.title = element_text(hjust = 0.5))

# 画 Cohen's d for ACC
ggplot(df_combined, aes(x = Condition, y = Cohens_d_ACC, color = Condition)) +
  geom_violin(trim = FALSE, fill = "lightgreen", alpha = 0.6) +
  geom_jitter(width = 0.1, size = 2, shape = 16, color = "darkgreen") +
  theme_minimal() +
  labs(title = "Cohen's d for ACC", y = "Cohen's d", x = "Condition") +
  theme(legend.position = "none") +
  theme(plot.title = element_text(hjust = 0.5))

```

# Δ
```{r}
# 画 deta_RT
ggplot(df_combined, aes(x = Condition, y = deta_RT, color = Condition)) +
  geom_violin(trim = FALSE, fill = "lightblue", alpha = 0.6) +
  geom_jitter(width = 0.1, size = 2, shape = 16, color = "darkblue") +
  theme_minimal() +
  labs(title = "deta_RT", y = "deta_RT", x = "Condition") +
  theme(legend.position = "none") +
  theme(plot.title = element_text(hjust = 0.5))

# 画 deta_ACC
ggplot(df_combined, aes(x = Condition, y = deta_ACC, color = Condition)) +
  geom_violin(trim = FALSE, fill = "darkgreen", alpha = 0.6) +
  geom_jitter(width = 0.1, size = 2, shape = 16, color = "lightgreen") +
  theme_minimal() +
  labs(title = "deta_ACC", y = "deta_ACC", x = "Condition") +
  theme(legend.position = "none") +
  theme(plot.title = element_text(hjust = 0.5))
```

