---
title: "Process_Data_v3"
author: "czx"
date: "`r Sys.Date()`"
output: html_document
---

# Process Coding
## Loading package
```{r Package, warning = FALSE,message = FALSE}
# clean data
library(tidyr)
library(dplyr)
library(stringr)
library(effsize)
library(here)
library(pwr)
library(ggplot2)
```

## Set data path 
```{r}
dataPath = "../1_Clean_Data"
data_files <- list.files(path = dataPath, pattern = "\\.csv$", full.names = TRUE, recursive = TRUE)
```

## Pre-allocate empty variables
```{r}
rt_self <- c()
rt_close <- c()
rt_stranger <- c()
rt_non_person <- c()
rt_acquaintance <- c()
cohens_d_self_close <- c()
cohens_d_self_stranger <- c()
cohens_d_self_non_person <- c()
cohens_d_self_acquaintance <- c()
counter <- 1
```

## Read csv
```{r}
# 遍历所有数据文件
for (i in 1:length(data_files)) {
  Data <- read.csv(data_files[i], fileEncoding = "UTF-8-BOM")
  
  # 确保数据包含 RT_ms 和 Standarlized_Identity
  if (all(c("RT_ms", "Standarlized_Identity", "Subject") %in% names(Data))) {
    
    # 获取当前数据集包含的 Identity（自动筛选）
    available_identities <- unique(Data$Standarlized_Identity)
    
    # 获取当前数据集的所有被试
    subs <- unique(Data$Subject)
    
    for (j in 1:length(subs)) {
      temp <- subset(Data, Subject == subs[j])
      
      # 标准化 RT（Z-score）
      temp$RT_z <- scale(temp$RT_ms)
      
      # 过滤异常反应时 (10ms < RT < 5000ms)
      temp <- subset(temp, RT_ms > 10 & RT_ms < 5000)
      
      # 计算 Self 的 RT 均值
      if ("Self" %in% available_identities) {
        rt_self[counter] <- mean(temp$RT_ms[temp$Standarlized_Identity == "Self"], na.rm = TRUE)
      } else {
        rt_self[counter] <- NA  # 若当前数据无 Self，则填充 NA
      }
      
      # 计算各个 Identity 的 RT 和 Cohen’s d
      if ("Close" %in% available_identities) {
        rt_close[counter] <- mean(temp$RT_ms[temp$Standarlized_Identity == "Close"], na.rm = TRUE)
        cohens_d_self_close[counter] <- (rt_self[counter] - rt_close[counter]) / 
          sqrt((var(temp$RT_ms[temp$Standarlized_Identity == "Self"], na.rm = TRUE) + 
                var(temp$RT_ms[temp$Standarlized_Identity == "Close"], na.rm = TRUE)) / 2)
      } else {
        rt_close[counter] <- NA
        cohens_d_self_close[counter] <- NA
      }
      
      if ("Stranger" %in% available_identities) {
        rt_stranger[counter] <- mean(temp$RT_ms[temp$Standarlized_Identity == "Stranger"], na.rm = TRUE)
        cohens_d_self_stranger[counter] <- (rt_self[counter] - rt_stranger[counter]) / 
          sqrt((var(temp$RT_ms[temp$Standarlized_Identity == "Self"], na.rm = TRUE) + 
                var(temp$RT_ms[temp$Standarlized_Identity == "Stranger"], na.rm = TRUE)) / 2)
      } else {
        rt_stranger[counter] <- NA
        cohens_d_self_stranger[counter] <- NA
      }
      
      if ("Nonperson" %in% available_identities) {
        rt_non_person[counter] <- mean(temp$RT_ms[temp$Standarlized_Identity == "NonPerson"], na.rm = TRUE)
        cohens_d_self_non_person[counter] <- (rt_self[counter] - rt_non_person[counter]) / 
          sqrt((var(temp$RT_ms[temp$Standarlized_Identity == "Self"], na.rm = TRUE) + 
                var(temp$RT_ms[temp$Standarlized_Identity == "Nonperson"], na.rm = TRUE)) / 2)
      } else {
        rt_non_person[counter] <- NA
        cohens_d_self_non_person[counter] <- NA
      }
      
      if ("Acquaintance" %in% available_identities) {
        rt_acquaintance[counter] <- mean(temp$RT_ms[temp$Standarlized_Identity == "Acquaintance"], na.rm = TRUE)
        cohens_d_self_acquaintance[counter] <- (rt_self[counter] - rt_acquaintance[counter]) / 
          sqrt((var(temp$RT_ms[temp$Standarlized_Identity == "Self"], na.rm = TRUE) + 
                var(temp$RT_ms[temp$Standarlized_Identity == "Acquaintance"], na.rm = TRUE)) / 2)
      } else {
        rt_acquaintance[counter] <- NA
        cohens_d_self_acquaintance[counter] <- NA
      }
      
      counter <- counter + 1
    }
  }
  print(paste('完成数据集', i, '处理'))
}

# 生成最终数据框
results <- data.frame(
  rt_self, rt_close, rt_stranger, rt_non_person, rt_acquaintance,
  cohens_d_self_close, cohens_d_self_stranger, cohens_d_self_non_person, cohens_d_self_acquaintance
)

# 输出数据到 CSV
write.csv(results, "Processed_Data.csv", row.names = FALSE)
```

## Pic1

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(Hmisc)
library(plyr)
library(RColorBrewer)
library(reshape2)

# 读取数据
data <- read.csv("Processed_Data.csv")

# 重新命名列以匹配需求
colnames(data) <- c("rt_self", "rt_close", "rt_stranger", "rt_non_person", "rt_acquaintance", 
                    "cohens_d_self_close", "cohens_d_self_stranger", "cohens_d_self_non_person", "cohens_d_self_acquaintance")

# 计算 RT 差值
data$SA_RT <- data$rt_self - data$rt_acquaintance
data$SC_RT <- data$rt_self - data$rt_close
data$SS_RT <- data$rt_self - data$rt_stranger
data$SN_RT <- data$rt_self - data$rt_non_person

# 定义 geom_flat_violin
"%||%" <- function(a, b) { if (!is.null(a)) a else b }

geom_flat_violin <- function(mapping = NULL, data = NULL, stat = "ydensity",
                             position = "dodge", trim = TRUE, scale = "area",
                             show.legend = NA, inherit.aes = TRUE, ...) {
  layer(
    data = data,
    mapping = mapping,
    stat = stat,
    geom = GeomFlatViolin,
    position = position,
    show.legend = show.legend,
    inherit.aes = inherit.aes,
    params = list(
      trim = trim,
      scale = scale,
      ...
    )
  )
}

GeomFlatViolin <- ggproto("GeomFlatViolin", Geom,
          setup_data = function(data, params) {
            data$width <- data$width %||%
              params$width %||% (resolution(data$x, FALSE) * 0.9)
            
            data %>%
              group_by(group) %>%
              mutate(ymin = min(y),
                     ymax = max(y),
                     xmin = x,
                     xmax = x + width / 2)
          },
          draw_group = function(data, panel_scales, coord) {
            data <- transform(data, xminv = x,
                              xmaxv = x + violinwidth * (xmax - x))
            newdata <- rbind(plyr::arrange(transform(data, x = xminv), y),
                             plyr::arrange(transform(data, x = xmaxv), -y))
            newdata <- rbind(newdata, newdata[1,])
            ggplot2:::ggname("geom_flat_violin", GeomPolygon$draw_panel(newdata, panel_scales, coord))
          },
          draw_key = draw_key_polygon,
          default_aes = aes(weight = 1, colour = "grey20", fill = "white", size = 0.5,
                            alpha = NA, linetype = "solid"),
          required_aes = c("x", "y")
)

raincloud_theme <- theme(
  text = element_text(size = 10),
  axis.title.x = element_text(size = 16),
  axis.title.y = element_text(size = 16),
  axis.text = element_text(size = 14),
  axis.text.x = element_text(angle = 45, vjust = 0.5),
  legend.title = element_text(size = 16),
  legend.text = element_text(size = 16),
  legend.position = "right",
  plot.title = element_text(lineheight = .8, face = "bold", size = 16),
  panel.border = element_blank(),
  panel.grid.minor = element_blank(),
  panel.grid.major = element_blank(),
  axis.line.x = element_line(colour = 'black', size = 0.5, linetype = 'solid'),
  axis.line.y = element_line(colour = 'black', size = 0.5, linetype = 'solid')
)

# 画图函数
generate_plot <- function(x_var, y_var, x_label, y_label, title) {
  ggplot(data, aes_string(x = x_var, y = y_var)) +
    geom_point(color = "blue", alpha = 0.6) +
    geom_boxplot(width = 0.2, outlier.shape = NA) +
    geom_flat_violin(aes(fill = ..density..), scale = "width", trim = FALSE, alpha = 0.5) +
    geom_smooth(method = "lm", color = "red", se = TRUE) +
    theme_minimal() +
    raincloud_theme +
    labs(x = x_label, y = y_label, title = title)
}

# 绘制四个图
p1.1 <- generate_plot("SA_RT", "cohens_d_self_acquaintance", "SA_RT", "Cohen's d (Self - Acquaintance)", "P1.1: RT vs. Cohen's d (Self - Acquaintance)")
p1.2 <- generate_plot("SC_RT", "cohens_d_self_close", "SC_RT", "Cohen's d (Self - Close)", "P1.2: RT vs. Cohen's d (Self - Close)")
p1.3 <- generate_plot("SS_RT", "cohens_d_self_stranger", "SS_RT", "Cohen's d (Self - Stranger)", "P1.3: RT vs. Cohen's d (Self - Stranger)")
p1.4 <- generate_plot("SN_RT", "cohens_d_self_non_person", "SN_RT", "Cohen's d (Self - Non-Person)", "P1.4: RT vs. Cohen's d (Self - Non-Person)")

# 显示所有图形
library(gridExtra)
grid.arrange(p1.1, p1.2, p1.3, p1.4, ncol = 2)

```

